<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Detalles de la Orden</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
    <style>
        body { max-width: 900px; margin: 40px auto; }
        .order-summary { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .add-item-form { background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="order-summary">
        <h2>Orden #{{ order['id'] }} - Mesa {{ order['table_number'] }}</h2>
        <p><strong>Cliente:</strong> {{ order['customer_name'] or 'Sin nombre' }}</p>
        <p><strong>Iniciada:</strong> {{ order['created_at'][:16] }}</p>
        <p><strong>Estado:</strong> {{ order['status'].title() }}</p>
    </div>
    
    {% if payments and order['status'] == 'closed' %}
    <div style="background: #e8f5e8; padding: 15px; margin: 20px 0; border-radius: 4px; border-left: 4px solid #4caf50;">
        <h4>üí≥ Pagos Realizados</h4>
        {% for payment in payments %}
        <div style="margin-bottom: 8px;">
            <strong>
                {% if payment['payment_method'] == 'efectivo' %}Efectivo
                {% elif payment['payment_method'] == 'transferencia' %}Transferencia Bancaria
                {% elif payment['payment_method'] == 'qr' %}C√≥digo QR
                {% elif payment['payment_method'] == 'tarjeta' %}Tarjeta
                {% else %}{{ payment['payment_method'] }}
                {% endif %}
            </strong>: ${{ "%.2f"|format(payment['amount']) }}
            <small style="color: #666; margin-left: 10px;">{{ payment['created_at'][:16] }}</small>
        </div>
        {% endfor %}
        <div style="border-top: 1px solid #4caf50; margin-top: 10px; padding-top: 8px;">
            <strong>Total Pagado: ${{ "%.2f"|format(payments|sum(attribute='amount')) }}</strong>
        </div>
    </div>
    {% endif %}
    
    <a href="{{ url_for('orders.orders') }}" class="button">Volver a √ìrdenes</a>
    
    {% if order['status'] == 'active' %}
    <button type="button" onclick="showPaymentModal()">Cerrar Orden</button>
    
    <!-- Split Payment Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3>M√©todos de Pago</h3>
            <p><strong>Total de la Orden: $<span id="orderTotal">{{ "%.2f"|format(total) }}</span></strong></p>
            
            <form action="{{ url_for('orders.close_order', order_id=order['id']) }}" method="post" id="paymentForm">
                <div id="paymentsContainer">
                    <!-- First payment row -->
                    <div class="payment-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <select name="payment_method[]" required style="flex: 1;">
                            <option value="efectivo">Efectivo</option>
                            <option value="transferencia">Transferencia Bancaria</option>
                            <option value="qr">C√≥digo QR</option>
                            <option value="tarjeta">Tarjeta</option>
                        </select>
                        <input type="number" name="amount[]" placeholder="Monto" step="0.01" min="0.01" required style="width: 100px;" onchange="updateRemaining()">
                        <button type="button" onclick="removePayment(this)" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px;">‚ùå</button>
                    </div>
                </div>
                
                <button type="button" onclick="addPayment()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-bottom: 15px;">+ Agregar M√©todo</button>
                
                <div style="margin-bottom: 20px;">
                    <strong>Restante: $<span id="remaining">{{ "%.2f"|format(total) }}</span></strong>
                    <div id="validation-error" style="color: red; margin-top: 5px; display: none;"></div>
                </div>
                
                <div>
                    <button type="submit" id="closeBtn" disabled style="margin-right: 10px; background: #666; color: white; border: none; padding: 10px 20px; border-radius: 4px;">Cerrar Orden</button>
                    <button type="button" onclick="hidePaymentModal()" style="background: #ddd; border: none; padding: 10px 20px; border-radius: 4px;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const orderTotal = {{ total }};
        
        function showPaymentModal() {
            document.getElementById('paymentModal').style.display = 'block';
            updateRemaining();
        }
        
        function hidePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }
        
        function addPayment() {
            const container = document.getElementById('paymentsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'payment-row';
            newRow.style = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            newRow.innerHTML = `
                <select name="payment_method[]" required style="flex: 1;">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia Bancaria</option>
                    <option value="qr">C√≥digo QR</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
                <input type="number" name="amount[]" placeholder="Monto" step="0.01" min="0.01" required style="width: 100px;" onchange="updateRemaining()">
                <button type="button" onclick="removePayment(this)" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px;">‚ùå</button>
            `;
            container.appendChild(newRow);
        }
        
        function removePayment(btn) {
            const rows = document.querySelectorAll('.payment-row');
            if (rows.length > 1) {  // Don't remove the last payment row
                btn.parentElement.remove();
                updateRemaining();
            }
        }
        
        function updateRemaining() {
            const amountInputs = document.querySelectorAll('input[name="amount[]"]');
            let totalPayments = 0;
            
            amountInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                totalPayments += value;
            });
            
            const remaining = orderTotal - totalPayments;
            document.getElementById('remaining').textContent = remaining.toFixed(2);
            
            const closeBtn = document.getElementById('closeBtn');
            const errorDiv = document.getElementById('validation-error');
            
            if (Math.abs(remaining) < 0.01) {  // Allow 1 cent rounding
                closeBtn.disabled = false;
                closeBtn.style.background = '#4caf50';
                errorDiv.style.display = 'none';
            } else {
                closeBtn.disabled = true;
                closeBtn.style.background = '#666';
                if (remaining < 0) {
                    errorDiv.textContent = `Exceso de $${Math.abs(remaining).toFixed(2)}`;
                    errorDiv.style.display = 'block';
                } else {
                    errorDiv.textContent = `Faltan $${remaining.toFixed(2)}`;
                    errorDiv.style.display = 'block';
                }
            }
        }
        
        // Close modal when clicking outside
        document.getElementById('paymentModal').onclick = function(e) {
            if (e.target === this) {
                hidePaymentModal();
            }
        }
    </script>
    {% endif %}
    
    <h3>Art√≠culos de la Orden</h3>
    {% if order_items %}
        <table>
            <thead>
                <tr>
                    <th>Art√≠culo</th>
                    <th>Categor√≠a</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Notas</th>
                    {% if order['status'] == 'active' %}<th>Acciones</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td>{{ item['name'] }}</td>
                    <td>{{ item['category'].title() }}</td>
                    <td>
                        {% if order['status'] == 'active' %}
                        <form action="{{ url_for('orders.edit_order_item', order_id=order['id'], item_id=item['id']) }}" method="post" style="display:inline;">
                            <input type="number" name="quantity" value="{{ item['quantity'] }}" min="1" style="width:60px;" onchange="this.form.submit()">
                            <input type="hidden" name="notes" value="{{ item['notes'] or '' }}">
                        </form>
                        {% else %}
                        {{ item['quantity'] }}
                        {% endif %}
                    </td>
                    <td>${{ "%.2f"|format(item['unit_price']) }}</td>
                    <td>${{ "%.2f"|format(item['quantity'] * item['unit_price']) }}</td>
                    <td>
                        {% if order['status'] == 'active' %}
                        <form action="{{ url_for('orders.edit_order_item', order_id=order['id'], item_id=item['id']) }}" method="post" style="display:inline;">
                            <input type="text" name="notes" value="{{ item['notes'] or '' }}" style="width:100px;" placeholder="Notas">
                            <input type="hidden" name="quantity" value="{{ item['quantity'] }}">
                            <button type="submit" style="background:none;border:none;color:blue;cursor:pointer;">üíæ</button>
                        </form>
                        {% else %}
                        {{ item['notes'] or '-' }}
                        {% endif %}
                    </td>
                    {% if order['status'] == 'active' %}
                    <td>
                        <form action="{{ url_for('orders.remove_order_item', order_id=order['id'], item_id=item['id']) }}" method="post" style="display:inline;" onsubmit="return confirm('¬øEliminar este art√≠culo?')">
                            <button type="submit" style="background:none;border:none;color:red;cursor:pointer;">üóëÔ∏è</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                <tr style="font-weight: bold; border-top: 2px solid #333;">
                    <td colspan="4">Total</td>
                    <td>${{ "%.2f"|format(total) }}</td>
                    <td></td>
                    {% if order['status'] == 'active' %}<td></td>{% endif %}
                </tr>
            </tbody>
        </table>
    {% else %}
        <p>No se han ordenado art√≠culos a√∫n.</p>
    {% endif %}
    
    {% if order['status'] == 'active' %}
    <div class="add-item-form">
        <h4>Agregar Art√≠culo a la Orden</h4>
        <form action="{{ url_for('orders.add_order_item', order_id=order['id']) }}" method="post">
            <label>Art√≠culo del Men√∫
                <select name="menu_item_id" required>
                    <option value="">Seleccionar art√≠culo...</option>
                    {% for item in menu_items %}
                    <option value="{{ item['id'] }}">{{ item['name'] }} ({{ item['category'].title() }}) - ${{ "%.2f"|format(item['price']) }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Cantidad
                <input type="number" name="quantity" value="1" min="1" required>
            </label>
            <label>Notas Especiales
                <input type="text" name="notes" placeholder="Solicitudes especiales, modificaciones, etc.">
            </label>
            <button type="submit">Agregar Art√≠culo</button>
        </form>
    </div>
    {% endif %}
</body>
</html>