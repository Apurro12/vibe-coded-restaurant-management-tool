<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Detalles de la Orden</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
    <style>
        body { max-width: 900px; margin: 40px auto; }
        .order-summary { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .add-item-form { background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="order-summary">
        <h2>Orden #{{ order['id'] }} - Mesa {{ order['table_number'] }}</h2>
        <p><strong>Cliente:</strong> {{ order['customer_name'] or 'Sin nombre' }}</p>
        <p><strong>Iniciada:</strong> {{ order['created_at'][:16] }}</p>
        <p><strong>Estado:</strong> {{ order['status'].title() }}</p>
        <p><strong>M√©todo de Pago:</strong> 
            {% if order['payment_method'] == 'efectivo' %}Efectivo
            {% elif order['payment_method'] == 'transferencia' %}Transferencia Bancaria
            {% elif order['payment_method'] == 'qr' %}C√≥digo QR
            {% elif order['payment_method'] == 'tarjeta' %}Tarjeta
            {% else %}{{ order['payment_method'] or 'No especificado' }}
            {% endif %}
        </p>
    </div>
    
    <a href="{{ url_for('orders') }}" class="button">Volver a √ìrdenes</a>
    
    {% if order['status'] == 'active' %}
    <button type="button" onclick="showPaymentModal()">Cerrar Orden</button>
    
    <!-- Payment Method Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3>Seleccionar M√©todo de Pago</h3>
            <form action="{{ url_for('close_order', order_id=order['id']) }}" method="post">
                <label>M√©todo de Pago
                    <select name="payment_method" required style="margin-bottom: 20px;">
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia Bancaria</option>
                        <option value="qr">C√≥digo QR</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                </label>
                <div>
                    <button type="submit" style="margin-right: 10px;">Cerrar Orden</button>
                    <button type="button" onclick="hidePaymentModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        function showPaymentModal() {
            document.getElementById('paymentModal').style.display = 'block';
        }
        
        function hidePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        document.getElementById('paymentModal').onclick = function(e) {
            if (e.target === this) {
                hidePaymentModal();
            }
        }
    </script>
    {% endif %}
    
    <h3>Art√≠culos de la Orden</h3>
    {% if order_items %}
        <table>
            <thead>
                <tr>
                    <th>Art√≠culo</th>
                    <th>Categor√≠a</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Notas</th>
                    {% if order['status'] == 'active' %}<th>Acciones</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td>{{ item['name'] }}</td>
                    <td>{{ item['category'].title() }}</td>
                    <td>
                        {% if order['status'] == 'active' %}
                        <form action="{{ url_for('edit_order_item', order_id=order['id'], item_id=item['id']) }}" method="post" style="display:inline;">
                            <input type="number" name="quantity" value="{{ item['quantity'] }}" min="1" style="width:60px;" onchange="this.form.submit()">
                            <input type="hidden" name="notes" value="{{ item['notes'] or '' }}">
                        </form>
                        {% else %}
                        {{ item['quantity'] }}
                        {% endif %}
                    </td>
                    <td>${{ "%.2f"|format(item['unit_price']) }}</td>
                    <td>${{ "%.2f"|format(item['quantity'] * item['unit_price']) }}</td>
                    <td>
                        {% if order['status'] == 'active' %}
                        <form action="{{ url_for('edit_order_item', order_id=order['id'], item_id=item['id']) }}" method="post" style="display:inline;">
                            <input type="text" name="notes" value="{{ item['notes'] or '' }}" style="width:100px;" placeholder="Notas">
                            <input type="hidden" name="quantity" value="{{ item['quantity'] }}">
                            <button type="submit" style="background:none;border:none;color:blue;cursor:pointer;">üíæ</button>
                        </form>
                        {% else %}
                        {{ item['notes'] or '-' }}
                        {% endif %}
                    </td>
                    {% if order['status'] == 'active' %}
                    <td>
                        <form action="{{ url_for('remove_order_item', order_id=order['id'], item_id=item['id']) }}" method="post" style="display:inline;" onsubmit="return confirm('¬øEliminar este art√≠culo?')">
                            <button type="submit" style="background:none;border:none;color:red;cursor:pointer;">üóëÔ∏è</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                <tr style="font-weight: bold; border-top: 2px solid #333;">
                    <td colspan="4">Total</td>
                    <td>${{ "%.2f"|format(total) }}</td>
                    <td></td>
                    {% if order['status'] == 'active' %}<td></td>{% endif %}
                </tr>
            </tbody>
        </table>
    {% else %}
        <p>No se han ordenado art√≠culos a√∫n.</p>
    {% endif %}
    
    {% if order['status'] == 'active' %}
    <div class="add-item-form">
        <h4>Agregar Art√≠culo a la Orden</h4>
        <form action="{{ url_for('add_order_item', order_id=order['id']) }}" method="post">
            <label>Art√≠culo del Men√∫
                <select name="menu_item_id" required>
                    <option value="">Seleccionar art√≠culo...</option>
                    {% for item in menu_items %}
                    <option value="{{ item['id'] }}">{{ item['name'] }} ({{ item['category'].title() }}) - ${{ "%.2f"|format(item['price']) }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Cantidad
                <input type="number" name="quantity" value="1" min="1" required>
            </label>
            <label>Notas Especiales
                <input type="text" name="notes" placeholder="Solicitudes especiales, modificaciones, etc.">
            </label>
            <button type="submit">Agregar Art√≠culo</button>
        </form>
    </div>
    {% endif %}
</body>
</html>